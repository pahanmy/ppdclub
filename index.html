<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran Keahlian PPD CLUB - PPD Miri</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #003399 0%, #2575fc 100%);
            --primary-color: #003399;
            --accent-color: #e74c3c;
            --success-color: #00b09b;
            --warning-color: #f39c12;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow-soft: 0 10px 30px rgba(0, 51, 153, 0.15);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            margin: 0;
            padding: 20px;
            display: flex;
            /* Logo di atas kotak (Column) */
            flex-direction: column; 
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
            gap: 20px; /* Jarak antara logo dan kotak */
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Animasi Melompat (Float) */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* Styling Logo Utama (Di luar kotak) */
        .main-logo {
            width: 160px; 
            height: auto;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2));
            transition: transform 0.3s ease;
            animation: float 3s ease-in-out infinite;
            z-index: 10;
        }
        
        .main-logo:hover {
            transform: scale(1.1);
        }

        .container {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 600px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h2 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
        }

        .header p {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
            font-weight: 300;
        }
        
        /* Contact & Link Buttons Container */
        .header-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        /* WhatsApp Button */
        .whatsapp-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: white;
            color: #25D366;
            padding: 8px 15px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85em;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.2);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid #25D366;
        }

        .whatsapp-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(37, 211, 102, 0.4);
            background: #25D366;
            color: white;
        }

        /* Wall of Members Button */
        .wall-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #FFD700, #FDB931);
            color: #333;
            padding: 8px 15px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            font-size: 0.85em;
            box-shadow: 0 5px 15px rgba(253, 185, 49, 0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid #FDB931;
        }

        .wall-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(253, 185, 49, 0.5);
            background: #fff;
            color: #FDB931;
        }

        /* Modern Tabs */
        .nav-tabs {
            display: flex;
            background: #f1f3f5;
            padding: 5px;
            border-radius: 50px;
            margin-bottom: 30px;
            position: relative;
        }

        .nav-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #777;
            border-radius: 50px;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .nav-tab.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.85em;
            color: #444;
            letter-spacing: 0.5px;
        }

        input[type="text"], 
        input[type="number"], 
        input[type="date"],
        input[type="file"],
        select {
            width: 100%;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 15px;
            font-family: 'Poppins', sans-serif;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }

        input[type="text"] {
            text-transform: uppercase;
        }

        input:focus, select:focus {
            border-color: #2575fc;
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 117, 252, 0.1);
            outline: none;
        }

        /* Photo Upload Styling */
        .photo-preview-container {
            text-align: center;
            margin-top: 10px;
            display: none;
        }
        
        .photo-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .upload-status {
            font-size: 0.8em;
            margin-top: 5px;
            font-weight: bold;
        }

        /* Checkbox Styling */
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #fff;
            border: 2px solid #eee;
            border-radius: 12px;
            transition: border-color 0.3s;
        }

        .checkbox-group:hover {
            border-color: #2575fc;
        }

        .checkbox-group input[type="checkbox"] {
            margin-top: 4px;
            margin-right: 12px;
            transform: scale(1.3);
            accent-color: var(--primary-color);
            cursor: pointer;
        }

        .checkbox-group label {
            font-weight: normal;
            font-size: 0.9em;
            line-height: 1.5;
            color: #555;
            cursor: pointer;
            margin: 0;
        }

        /* Fee Notice & Table Styling */
        .fee-notice {
            background: linear-gradient(to right, #fff3cd, #fff8e1);
            color: #856404;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #ffc107;
            margin-bottom: 25px;
            font-size: 0.9em;
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.1);
        }

        .benefits-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            overflow: hidden;
        }

        .benefits-table th, .benefits-table td {
            border: 1px solid #d3b95f;
            padding: 10px;
            text-align: left;
            vertical-align: middle;
        }

        .benefits-table th {
            background-color: rgba(255, 193, 7, 0.2);
            color: #856404;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85em;
        }

        .benefits-table tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.4);
        }
        
        .benefits-table strong {
            color: #5d4037;
        }

        /* Verification Box */
        .verification-box {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            animation: fadeIn 0.5s;
            display: none;
        }

        .verification-title {
            color: #0d47a1;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .btn-verify {
            background: #2196f3;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-weight: 600;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-verify:hover { background: #1976d2; }

        /* Buttons */
        .btn-submit {
            background: var(--primary-gradient);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 12px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
            font-weight: 700;
            letter-spacing: 1px;
            box-shadow: 0 10px 20px rgba(0, 51, 153, 0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(0, 51, 153, 0.4);
        }

        /* Standard Modern Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 16px;
            width: 90%; 
            max-width: 480px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            animation: zoomIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Close Button (X) */
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
            line-height: 1;
            z-index: 5;
        }
        .close-btn:hover {
            color: #333;
        }

        @keyframes zoomIn {
            from { transform: scale(0.95) translateY(20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* PREMIUM MEMBER CARD STYLES - GOLD EDITION */
        .member-card {
            /* Latar belakang Emas Mewah */
            background: radial-gradient(ellipse farthest-corner at right bottom, #FEDB37 0%, #FDB931 8%, #9f7928 30%, #8A6E2F 40%, transparent 80%),
                        radial-gradient(ellipse farthest-corner at left top, #FFFFFF 0%, #FFFFAC 8%, #D1B464 25%, #5d4a1f 62.5%, #5d4a1f 100%);
            color: #2c3e50; /* Teks gelap supaya kontras dengan emas */
            padding: 25px;
            border-radius: 16px;
            box-shadow: 
                0 15px 35px rgba(138, 110, 47, 0.4),
                inset 0 0 0 1px rgba(255,255,255,0.4);
            text-align: left;
            position: relative;
            overflow: hidden;
            margin: 10px 0 20px 0;
            font-family: 'Poppins', sans-serif;
            transition: opacity 0.3s;
        }

        /* Efek Berkilat/Texture */
        .member-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                linear-gradient(125deg, rgba(255,255,255,0) 40%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 60%);
            pointer-events: none;
            background-size: 200% 200%;
            animation: shine 5s infinite;
        }
        
        @keyframes shine {
            0% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(44, 62, 80, 0.2);
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .card-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-logo-img {
            height: 45px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .card-logo {
            font-weight: 800;
            font-size: 1.1em;
            letter-spacing: 1px;
            color: #1a252f;
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
            background: none;
            -webkit-text-fill-color: #1a252f;
        }

        .card-subtitle {
            font-size: 0.6em;
            background: #2c3e50;
            color: #FDB931;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .card-body {
            display: flex;
            flex-direction: row; 
            gap: 15px;
            position: relative;
            z-index: 2;
            align-items: center;
        }

        .card-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-photo-box {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.8);
            overflow: hidden;
            background: rgba(255,255,255,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card-photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-field { margin-bottom: 0; }

        .card-label {
            font-size: 0.6em;
            opacity: 0.8;
            color: #4a4a4a;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
            font-weight: 600;
        }

        .card-value {
            font-size: 1.1em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #000;
            text-shadow: 0 1px 0 rgba(255,255,255,0.4);
        }

        .barcode-container {
            background: rgba(255,255,255,0.9);
            color: black;
            padding: 10px;
            text-align: center;
            margin-top: 20px;
            border-radius: 8px;
            position: relative;
            z-index: 2;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .barcode {
            font-family: 'Libre Barcode 39 Text', cursive;
            font-size: 42px;
            line-height: 1;
        }

        /* Overlay untuk status PENDING pada kad */
        .pending-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10;
            backdrop-filter: blur(2px);
        }
        
        .pending-stamp {
            border: 3px solid #ffc107;
            color: #ffc107;
            padding: 10px 20px;
            font-size: 1.5em;
            font-weight: 800;
            transform: rotate(-15deg);
            text-transform: uppercase;
            letter-spacing: 2px;
            background: rgba(0,0,0,0.5);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn-confirm, .btn-cancel {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn-confirm {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 5px 15px rgba(0,51,153,0.3);
        }

        .btn-cancel {
            background-color: #f1f3f5;
            color: #555;
        }

        .btn-confirm:hover, .btn-cancel:hover {
            transform: scale(1.05);
        }

        #personal-details {
            animation: slideUp 0.5s ease-out;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>

<img src="https://i.postimg.cc/3JqzZXqd/TRANSPARENT-BACK-GROUND.png" alt="Logo PPD Club" class="main-logo">

<div class="container">
    <div class="header">
        <h2>Pendaftaran Keahlian PPD CLUB</h2>
        <p>PEJABAT PENDIDIKAN DAERAH MIRI</p>
        
        <div class="header-actions">
            <a href="https://wa.me/60135792215?text=Salam%20Admin%2C%20saya%20ada%20pertanyaan%20mengenai%20Pendaftaran%20PPD%20Club." target="_blank" class="whatsapp-link">
                <i class="fab fa-whatsapp" style="font-size: 1.3em; margin-right: 8px;"></i> Hubungi Admin
            </a>
            
            <a href="member.html" class="wall-link" target="_blank">
                <i class="fas fa-address-card" style="font-size: 1.2em; margin-right: 8px;"></i> Lihat Semua Ahli
            </a>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('daftar')">DAFTAR BARU</div>
        <div class="nav-tab" onclick="switchTab('semak')">SEMAKAN KEAHLIAN</div>
    </div>

    <div id="registerSection">
        <form id="registrationForm">
            <div class="form-group">
                <label for="ic_number">NO. KAD PENGENALAN (Tanpa Sengkang)</label>
                <input type="text" name="ic" id="ic_number" maxlength="12" placeholder="Contoh: 850101135050" required>
            </div>

            <div id="icCheckLoader" class="loader" style="margin-bottom: 20px;"></div>

            <div id="verificationBox" class="verification-box">
                <div class="verification-title">
                    <i class="fas fa-info-circle"></i> REKOD DITEMUI
                </div>
                <p style="font-size:0.9em; margin-bottom:15px; color:#555;">
                    No. IC ini telah berdaftar. Untuk mengemaskini maklumat, sila masukkan <strong>No. Telefon</strong> yang telah didaftarkan untuk pengesahan.
                </p>
                <input type="text" id="verify_phone" placeholder="Masukkan No. Telefon (Contoh: 013XXXXXXX)">
                <button type="button" class="btn-verify" onclick="verifyAndLoadData()">SAHKAN & KEMASKINI</button>
            </div>

            <div id="personal-details" style="display: none;">
                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label>TARIKH LAHIR</label>
                        <input type="text" name="dob" id="dob" class="readonly-field" readonly style="background: #e9ecef; cursor: not-allowed;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>JANTINA</label>
                        <input type="text" name="jantina" id="gender" class="readonly-field" readonly style="background: #e9ecef; cursor: not-allowed;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="fullname">NAMA PENUH</label>
                    <input type="text" name="nama" id="fullname" placeholder="MASUKKAN NAMA PENUH SEPERTI DALAM IC" required>
                </div>

                <div class="form-group">
                    <label for="photo_upload">FOTO PROFIL / PASPORT <span style="font-size: 0.8em; color: #888; font-weight: normal;">(Pilihan)</span></label>
                    <input type="file" id="photo_upload" accept="image/*" onchange="uploadImage(this)">
                    <small style="color: #666; font-size: 0.85em; display: block; margin-top: 5px;">
                        Masukkan gambar untuk tujuan rekod keahlian. <strong>Tidak wajib</strong> (Optional).
                    </small>
                    
                    <div class="photo-preview-container" id="photoPreviewBox">
                        <img src="" alt="Preview" class="photo-preview" id="previewImg">
                        <div id="uploadStatus" class="upload-status"></div>
                    </div>
                    <input type="hidden" id="foto_url" name="foto_url">
                </div>

                <div class="form-group">
                    <label for="status_kahwin">STATUS PERKAHWINAN</label>
                    <select id="status_kahwin" name="status_kahwin" required>
                        <option value="">- SILA PILIH -</option>
                        <option value="BUJANG">BUJANG</option>
                        <option value="BERKAHWIN">BERKAHWIN</option>
                        <option value="DUDA">DUDA</option>
                        <option value="JANDA">JANDA</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sector">SEKTOR</label>
                    <select id="sector" name="sektor" required>
                        <option value="">- PILIH SEKTOR -</option>
                        <option value="SEKTOR PERANCANGAN">SEKTOR PERANCANGAN</option>
                        <option value="SEKTOR PEMBELAJARAN">SEKTOR PEMBELAJARAN</option>
                        <option value="SEKTOR PENGURUSAN SEKOLAH">SEKTOR PENGURUSAN SEKOLAH</option>
                        <option value="SEKTOR PEMBANGUNAN MURID">SEKTOR PEMBANGUNAN MURID</option>
                        <option value="SEKTOR PENTAKSIRAN & PEPERIKSAAN">SEKTOR PENTAKSIRAN & PEPERIKSAAN</option>
                        <option value="SEKTOR PSIKOLOGI & KAUNSELING">SEKTOR PSIKOLOGI & KAUNSELING</option>
                        <option value="SEKTOR PENGURUSAN">SEKTOR PENGURUSAN</option>
                        <option value="LAIN-LAIN">LAIN-LAIN</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="unit">UNIT / SUB-UNIT (Jika Ada)</label>
                    <input type="text" name="unit" id="unit" placeholder="Contoh: Unit Kewangan / Unit ICT" required>
                </div>

                <div class="form-group">
                    <label for="jawatan_select">JAWATAN</label>
                    <select id="jawatan_select" name="jawatan_select" onchange="toggleCustomJawatan(this)" required>
                        <option value="">- PILIH JAWATAN -</option>
                        <option value="PEGAWAI PENDIDIKAN DAERAH">PEGAWAI PENDIDIKAN DAERAH</option>
                        <option value="TIMBALAN PPD (PERANCANGAN)">TIMBALAN PPD (PERANCANGAN)</option>
                        <option value="TIMBALAN PPD (PEMBELAJARAN)">TIMBALAN PPD (PEMBELAJARAN)</option>
                        <option value="TIMBALAN PPD (PENGURUSAN SEKOLAH)">TIMBALAN PPD (PENGURUSAN SEKOLAH)</option>
                        <option value="TIMBALAN PPD (PEMBANGUNAN MURID)">TIMBALAN PPD (PEMBANGUNAN MURID)</option>
                        <option value="PENOLONG PEGAWAI PPD">PENOLONG PEGAWAI PPD</option>
                        <option value="KAUNSELOR PENDIDIKAN DAERAH">KAUNSELOR PENDIDIKAN DAERAH</option>
                        <option value="SISC+">SISC+</option>
                        <option value="SIPARTNER+">SIPARTNER+</option>
                        <option value="PEGAWAI EKSEKUTIF">PEGAWAI EKSEKUTIF</option>
                        <option value="PENOLONG PEGAWAI TADBIR">PENOLONG PEGAWAI TADBIR</option>
                        <option value="PENOLONG PEGAWAI TEKNOLOGI MAKLUMAT">PENOLONG PEGAWAI TEKNOLOGI MAKLUMAT</option>
                        <option value="PENOLONG JURUTERA">PENOLONG JURUTERA</option>
                        <option value="PENOLONG AKAUNTAN">PENOLONG AKAUNTAN</option>
                        <option value="PEMBANTU TADBIR (P/O)">PEMBANTU TADBIR (P/O)</option>
                        <option value="PEMBANTU TADBIR (KEWANGAN)">PEMBANTU TADBIR (KEWANGAN)</option>
                        <option value="PENYELIA ASRAMA">PENYELIA ASRAMA</option>
                        <option value="PEMBANTU PENGURUSAN MURID">PEMBANTU PENGURUSAN MURID</option>
                        <option value="JURUTEKNIK KOMPUTER">JURUTEKNIK KOMPUTER</option>
                        <option value="PEMBANTU OPERASI">PEMBANTU OPERASI</option>
                        <option value="PEMANDU KENDERAAN">PEMANDU KENDERAAN</option>
                        <option value="LAIN-LAIN">LAIN-LAIN (SILA NYATAKAN)</option>
                    </select>
                    <input type="text" id="jawatan_custom" name="jawatan_custom" placeholder="MASUKKAN NAMA JAWATAN ANDA DI SINI" style="display: none; margin-top: 10px; border-color: var(--accent-color);">
                </div>

                <div class="form-group">
                    <label for="start_date">TARIKH LAPOR DIRI DI PPD MIRI</label>
                    <input type="date" name="tarikh_mula" id="start_date" required>
                    
                    <div id="service_duration" class="duration-box" style="background-color: #e3f2fd; border-radius:10px; padding:15px; margin-top:10px; border: 1px solid #90caf9; color: #0d47a1; display:none;">
                        TEMPOH PERKHIDMATAN: <span id="duration_text" style="font-weight:700">-</span>
                    </div>
                    <input type="hidden" name="tempoh_khidmat" id="hidden_duration">

                    <div id="club_duration_box" class="duration-box" style="background-color: #e8f5e9; border-radius:10px; padding:15px; margin-top:10px; border: 1px solid #a5d6a7; color: #1b5e20; display: none;">
                        TEMPOH KEAHLIAN PPD CLUB: <span id="club_duration_text" style="font-weight: 800; font-size: 1.1em;">-</span>
                        <br><small style="font-weight: normal; font-size: 0.85em;">(Kiraan bermula dari Tahun 2024)</small>
                    </div>
                    <input type="hidden" name="tempoh_keahlian" id="hidden_club_duration">
                </div>

                <div class="form-group">
                    <label for="phone">NO. TELEFON</label>
                    <input type="text" name="phone" id="phone" placeholder="01X-XXXXXXX" required>
                </div>

                <div class="fee-notice">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <strong style="font-size: 1.2em; color: #856404; letter-spacing:1px;">üì¢ MAKLUMAN PENTING</strong>
                    </div>
                    
                    <p style="margin-bottom: 15px; border-bottom: 1px dashed #d3b95f; padding-bottom: 15px;">
                        Yuran keahlian PPD CLUB adalah sebanyak <strong style="font-size:1.1em">RM60.00 SETAHUN</strong>. 
                        <br><br>
                        <span style="font-size: 0.85em; font-style: italic; opacity:0.8;">
                            *Hasil Mesyuarat Jawatankuasa Induk PPD Club Bilangan 1 Tahun 2024 pada 29 November 2024.
                        </span>
                    </p>
                    
                    <strong style="display:block; margin-bottom:10px; color:#003399;">üéÅ FAEDAH KEAHLIAN:</strong>
                    
                    <table class="benefits-table">
                        <thead>
                            <tr>
                                <th>Kategori</th>
                                <th>Syarat / Tempoh</th>
                                <th>Kadar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td rowspan="2"><strong>üéÇ Hadiah</strong></td>
                                <td>Berkahwin</td>
                                <td>RM 30</td>
                            </tr>
                            <tr>
                                <td>Hari Jadi</td>
                                <td>RM 20</td>
                            </tr>
                            <tr>
                                <td rowspan="3"><strong>üë∂ Kelahiran Anak</strong><br><small>(Ikut Tempoh Keahlian)</small></td>
                                <td>Kurang 3 Tahun</td>
                                <td>RM 30</td>
                            </tr>
                            <tr>
                                <td>Kurang 5 Tahun</td>
                                <td>RM 50</td>
                            </tr>
                            <tr>
                                <td>5 Tahun ke atas</td>
                                <td>RM 70</td>
                            </tr>
                            <tr>
                                <td rowspan="4"><strong>üëã Bersara / Berpindah</strong><br><small>(Ikut Tempoh Keahlian)</small></td>
                                <td>Kurang 1 Tahun</td>
                                <td>RM 100</td>
                            </tr>
                            <tr>
                                <td>Kurang 3 Tahun</td>
                                <td>RM 200</td>
                            </tr>
                            <tr>
                                <td>Kurang 5 Tahun</td>
                                <td>RM 300</td>
                            </tr>
                            <tr>
                                <td>Lebih 5 Tahun</td>
                                <td>RM 400</td>
                            </tr>
                            <tr>
                                <td rowspan="4"><strong>üí∏ Kematian Ahli</strong><br><small>(Ikut Tempoh Keahlian)</small></td>
                                <td>Kurang 1 Tahun</td>
                                <td>RM 200</td>
                            </tr>
                            <tr>
                                <td>Kurang 3 Tahun</td>
                                <td>RM 500</td>
                            </tr>
                            <tr>
                                <td>Kurang 5 Tahun</td>
                                <td>RM 800</td>
                            </tr>
                            <tr>
                                <td>Lebih 5 Tahun</td>
                                <td>RM 1000</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="checkbox-group" style="background-color: #fffbf0; border-color: #ffd700;">
                    <input type="checkbox" id="physical_card_opt" name="physical_card_opt">
                    <label for="physical_card_opt">
                        <strong>TEMPAHAN KAD FIZIKAL (PVC) - RM13.00</strong><br>
                        <span style="font-size:0.9em; color:#666;">Tanda kotak ini jika anda ingin menempah kad fizikal keras (PVC) dengan bayaran tambahan.</span>
                    </label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="agreement_check" name="agreement_check" required>
                    <label for="agreement_check">
                        Dengan mendaftar ini, saya bersetuju, akan komited dan membantu dalam meningkatkan matlamat PPD CLUB. 
                        Saya juga mengambil maklum bahawa PPD CLUB berhak menolak permohonan atau melucutkan keahlian sekiranya difikirkan ada asas dan sebab yang wajar.
                    </label>
                </div>

                <button type="button" class="btn-submit" id="mainSubmitBtn" onclick="validateAndPreview()">DAFTAR KEAHLIAN SEKARANG</button>
            </div>
        </form>
    </div>

    <div id="checkSection" style="display: none;">
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 3em; margin-bottom: 10px;">üîç</div>
            <h3 style="margin:0; color:#444;">SEMAKAN STATUS</h3>
            <p style="color: #888;">Masukkan No. Kad Pengenalan anda untuk menyemak.</p>
        </div>
        
        <div class="form-group">
            <label for="check_ic" style="text-align: center;">NO. KAD PENGENALAN</label>
            <input type="text" id="check_ic" maxlength="12" placeholder="Contoh: 850101135050" style="font-size: 1.3em; letter-spacing: 2px; text-align: center; font-weight:bold; padding: 20px;">
        </div>

        <button type="button" class="btn-submit" onclick="checkMembership()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">SEMAK STATUS</button>
        
        <div id="checkLoader" class="loader" style="margin-top: 30px;"></div>
    </div>

</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        
        <h3 id="modalTitle" style="color: var(--primary-color); margin-bottom:5px; font-weight:800;">SAHKAN MAKLUMAT</h3>
        <p id="modalSubtitle" style="font-size:0.9em; color:#666; margin-bottom:20px;">Semak kad keahlian digital anda:</p>
        
        <div class="member-card">
            
            <div id="cardOverlay" class="pending-overlay">
                <div class="pending-stamp">MENUNGGU<br>PENGESAHAN</div>
            </div>

            <div class="card-header">
                <div class="card-brand">
                    <img src="https://i.postimg.cc/3JqzZXqd/TRANSPARENT-BACK-GROUND.png" alt="Logo" class="card-logo-img">
                    <div class="card-logo">PPD CLUB MIRI</div>
                </div>
                <div class="card-subtitle">PREMIUM MEMBER</div>
            </div>
            
            <div class="card-body">
                
                <div class="card-photo-box" id="cardPhotoBox">
                    <img src="https://via.placeholder.com/150?text=FOTO" alt="Foto Ahli" id="cardUserPhoto">
                </div>

                <div class="card-details">
                    <div class="card-field">
                        <div class="card-label">NAMA / NAME</div>
                        <div class="card-value" id="cardName">ALI BIN ABU</div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <div class="card-field">
                            <div class="card-label">NO. K/P / ID</div>
                            <div class="card-value" id="cardIC">850101-13-5050</div>
                        </div>
                        <div class="card-field" style="text-align: right;">
                            <div class="card-label">TEMPOH CLUB</div>
                            <div class="card-value" id="cardDuration">1 TAHUN</div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between;">
                        <div class="card-field">
                            <div class="card-label">TARIKH KEAHLIAN / JOIN DATE</div>
                            <div class="card-value" id="cardJoinDate" style="font-size:0.9em;">-</div>
                        </div>
                        <div class="card-field" style="text-align: right;">
                            <div class="card-label">NO. KEAHLIAN / MEMBER NO</div>
                            <div class="card-value" id="cardMemberID" style="color: #000; letter-spacing: 1px;">-</div>
                        </div>
                    </div>

                    <div class="card-field">
                        <div class="card-label">JAWATAN / POSITION</div>
                        <div class="card-value" id="cardJawatan" style="font-size:0.85em; white-space: normal; line-height:1.2;">PEGAWAI PENDIDIKAN</div>
                    </div>
                </div>
            </div>

            <div class="barcode-container">
                <div class="barcode" id="cardBarcode">*850101135050*</div>
                <div style="font-size:0.6em; margin-top:5px; letter-spacing:2px; font-weight:bold; color:#555;">ID SEMENTARA</div>
            </div>
        </div>

        <div id="registerFooter">
            <div id="feeDisplay" style="margin-top: 15px; font-size: 1.1em; background:#f8f9fa; padding:15px; border-radius:10px; line-height: 1.5;">
                YURAN TAHUNAN: <span style="color:var(--accent-color); font-weight:900;">RM60.00</span>
            </div>
            
            <div id="loading" class="loader" style="margin-top:15px"></div>
            <div id="statusMessage" style="color: green; font-weight: bold; margin-top: 10px;"></div>

            <div class="modal-buttons" id="modalBtns">
                <button class="btn-cancel" onclick="closeModal()">KEMBALI</button>
                <button class="btn-confirm" id="btnFinalSubmit" onclick="finalSubmit()">SAHKAN & HANTAR</button>
            </div>
        </div>

        <div id="checkFooter" style="display: none;">
             <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">TUTUP</button>
                <button class="btn-confirm" id="btnPrintCard" onclick="window.print()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">CETAK KAD</button>
            </div>
        </div>

    </div>
</div>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variable references
    const icInput = document.getElementById('ic_number');
    const detailsDiv = document.getElementById('personal-details');
    const verificationBox = document.getElementById('verificationBox');
    const startDateInput = document.getElementById('start_date');
    const durationBox = document.getElementById('service_duration');
    const durationText = document.getElementById('duration_text');
    const hiddenDuration = document.getElementById('hidden_duration');
    const clubDurationBox = document.getElementById('club_duration_box');
    const clubDurationText = document.getElementById('club_duration_text');
    const hiddenClubDuration = document.getElementById('hidden_club_duration');
    const icCheckLoader = document.getElementById('icCheckLoader');
    
    // ImgBB API Key Variable
    const imgbbAPIKey = 'a7c600ac733fe14649cacd8e65619c4b'; 

    // Global Vars for Edit Mode
    let editingDocId = null;
    let tempFoundData = null;

    // --- FIREBASE SETUP ---
    const firebaseConfig = {
      apiKey: "AIzaSyAZC1WyqVSlicy4jRIZyIFmx2rjlrbtfus",
      authDomain: "ppdclub-e9f2a.firebaseapp.com",
      projectId: "ppdclub-e9f2a",
      storageBucket: "ppdclub-e9f2a.firebasestorage.app",
      messagingSenderId: "72228598666",
      appId: "1:72228598666:web:1855035320bee1066c0e73"
    };

    let app, auth, db;
    let currentUser = null;

    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('statusMessage').innerText = "Ralat Sambungan Database. Sila semak console.";
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("System Ready. User ID:", user.uid);
            }
        });
    } catch (e) {
        console.error("Error initializing Firebase:", e);
    }

    // --- FORM LOGIC ---
    document.querySelectorAll('input[type="text"]').forEach(input => {
        input.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    });

    // Modified IC Input Logic
    icInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, ''); 
        const ic = this.value;

        // Reset state jika user ubah IC
        if (ic.length < 12) {
            detailsDiv.style.display = 'none';
            verificationBox.style.display = 'none';
            editingDocId = null;
            tempFoundData = null;
            document.getElementById('mainSubmitBtn').innerText = "DAFTAR KEAHLIAN SEKARANG";
        }

        if (ic.length === 12) {
            checkExistingRegistration(ic);
        }
    });

    // --- IMGBB UPLOAD LOGIC ---
    window.uploadImage = function(input) {
        const file = input.files[0];
        if (!file) return;

        const statusDiv = document.getElementById('uploadStatus');
        const previewBox = document.getElementById('photoPreviewBox');
        const previewImg = document.getElementById('previewImg');
        const hiddenUrlInput = document.getElementById('foto_url');

        statusDiv.innerHTML = '<span style="color:blue;">Sedang memuat naik... <i class="fas fa-spinner fa-spin"></i></span>';
        previewBox.style.display = 'block';
        
        // Show local preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
        }
        reader.readAsDataURL(file);

        // Upload to ImgBB
        const formData = new FormData();
        formData.append('image', file);

        fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPIKey}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const imageUrl = result.data.url; // Get direct link
                hiddenUrlInput.value = imageUrl;
                statusDiv.innerHTML = '<span style="color:green;">Muat naik berjaya!</span>';
            } else {
                statusDiv.innerHTML = '<span style="color:red;">Gagal muat naik: ' + (result.error ? result.error.message : 'Ralat tidak diketahui') + '</span>';
            }
        })
        .catch(error => {
            console.error('Error uploading:', error);
            statusDiv.innerHTML = '<span style="color:red;">Ralat sambungan. Sila cuba lagi.</span>';
        });
    };

    // Function: Check if User Exists (Logic Baru)
    async function checkExistingRegistration(ic) {
        if (!db) return;
        
        icCheckLoader.style.display = 'block';
        verificationBox.style.display = 'none';
        detailsDiv.style.display = 'none';

        try {
            // Fetch all (since we can't use where() easily with simple setup)
            const querySnapshot = await getDocs(collection(db, 'ppd_registrations'));
            let found = null;
            let docId = null;

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.ic === ic) {
                    found = data;
                    docId = doc.id;
                }
            });

            if (found) {
                // Rekod Jumpa -> Tunjuk Verification Box
                tempFoundData = { ...found, id: docId }; // Store temp
                verificationBox.style.display = 'block';
            } else {
                // Rekod Tak Jumpa -> Tunjuk Borang Daftar Baru
                extractICData(ic);
                detailsDiv.style.display = 'block';
                // Reset form fields
                document.getElementById('registrationForm').reset();
                document.getElementById('ic_number').value = ic; // Put IC back
                extractICData(ic); // Re-calc DOB
                editingDocId = null;
                document.getElementById('mainSubmitBtn').innerText = "DAFTAR KEAHLIAN SEKARANG";
                document.getElementById('photoPreviewBox').style.display = 'none'; // Hide preview
                document.getElementById('foto_url').value = ''; // Reset hidden URL
            }

        } catch (error) {
            console.error("Error checking IC:", error);
            alert("Ralat menyemak pangkalan data.");
        } finally {
            icCheckLoader.style.display = 'none';
        }
    }

    // Function: Verify Phone & Pre-fill Data
    window.verifyAndLoadData = function() {
        const phoneInput = document.getElementById('verify_phone').value.trim();
        const storedPhone = tempFoundData.phone;

        if (phoneInput === storedPhone) {
            alert("Pengesahan Berjaya! Sila kemaskini maklumat anda.");
            
            verificationBox.style.display = 'none';
            detailsDiv.style.display = 'block';
            
            editingDocId = tempFoundData.id;
            document.getElementById('mainSubmitBtn').innerText = "KEMASKINI MAKLUMAT";

            // Pre-fill form
            document.getElementById('fullname').value = tempFoundData.nama;
            document.getElementById('status_kahwin').value = tempFoundData.status_kahwin;
            document.getElementById('sector').value = tempFoundData.sektor;
            document.getElementById('unit').value = tempFoundData.unit;
            document.getElementById('phone').value = tempFoundData.phone;
            document.getElementById('start_date').value = tempFoundData.tarikh_mula;
            
            // Handle Photo Preview if exists
            if (tempFoundData.foto_url) {
                document.getElementById('foto_url').value = tempFoundData.foto_url;
                document.getElementById('previewImg').src = tempFoundData.foto_url;
                document.getElementById('photoPreviewBox').style.display = 'block';
                document.getElementById('uploadStatus').innerHTML = '<span style="color:green;">Gambar sedia ada dimuatkan.</span>';
            }

            // Handle Jawatan
            const jawatanSelect = document.getElementById('jawatan_select');
            const jawatanCustom = document.getElementById('jawatan_custom');
            
            let foundInList = false;
            for(let i=0; i<jawatanSelect.options.length; i++){
                if(jawatanSelect.options[i].value === tempFoundData.jawatan){
                    jawatanSelect.value = tempFoundData.jawatan;
                    foundInList = true;
                    break;
                }
            }
            
            if(!foundInList){
                jawatanSelect.value = "LAIN-LAIN";
                jawatanCustom.style.display = 'block';
                jawatanCustom.value = tempFoundData.jawatan;
            } else {
                jawatanCustom.style.display = 'none';
            }

            extractICData(tempFoundData.ic);
            startDateInput.dispatchEvent(new Event('change'));

        } else {
            alert("Nombor telefon tidak sepadan dengan rekod kami.");
        }
    }

    const checkIcInput = document.getElementById('check_ic');
    if (checkIcInput) {
        checkIcInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    }

    startDateInput.addEventListener('change', function() {
        const start = new Date(this.value);
        const now = new Date();

        if (start > now) {
            alert("Tarikh lapor diri tidak boleh melebihi tarikh hari ini.");
            this.value = "";
            durationBox.style.display = 'none';
            clubDurationBox.style.display = 'none';
            return;
        }

        const diff = calculateDuration(start, now);
        const resultString = `${diff.years} TAHUN, ${diff.months} BULAN`;
        durationText.innerText = resultString;
        hiddenDuration.value = resultString;
        durationBox.style.display = 'block';

        const startYear = start.getFullYear();
        const currentYear = now.getFullYear();
        const effectiveYear = startYear < 2024 ? 2024 : startYear;
        let clubYears = (currentYear - effectiveYear) + 1;
        if (clubYears < 1) clubYears = 1;

        const clubString = `${clubYears} TAHUN`;
        clubDurationText.innerText = clubString;
        hiddenClubDuration.value = clubString;
        clubDurationBox.style.display = 'block';
    });

    function calculateDuration(startDate, endDate) {
        let years = endDate.getFullYear() - startDate.getFullYear();
        let months = endDate.getMonth() - startDate.getMonth();
        let days = endDate.getDate() - startDate.getDate();
        if (days < 0) { months--; const prevMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 0); days += prevMonth.getDate(); }
        if (months < 0) { years--; months += 12; }
        return { years, months, days };
    }

    function extractICData(ic) {
        const lastDigit = parseInt(ic.substr(11, 1));
        const gender = (lastDigit % 2 !== 0) ? "LELAKI" : "PEREMPUAN";
        document.getElementById('gender').value = gender;
        let year = ic.substr(0, 2);
        const month = ic.substr(2, 2);
        const day = ic.substr(4, 2);
        const currentYearPrefix = new Date().getFullYear().toString().substr(2,2);
        const fullYear = (parseInt(year) > parseInt(currentYearPrefix)) ? "19" + year : "20" + year;
        document.getElementById('dob').value = `${day}/${month}/${fullYear}`;
    }

    window.toggleCustomJawatan = function(selectElement) {
        const customInput = document.getElementById('jawatan_custom');
        if (selectElement.value === 'LAIN-LAIN') {
            customInput.style.display = 'block';
            customInput.required = true;
            customInput.focus();
        } else {
            customInput.style.display = 'none';
            customInput.required = false;
            customInput.value = ''; 
        }
    }

    window.switchTab = function(tabName) {
        const tabs = document.querySelectorAll('.nav-tab');
        const regSection = document.getElementById('registerSection');
        const checkSection = document.getElementById('checkSection');
        tabs.forEach(t => t.classList.remove('active'));

        if (tabName === 'daftar') {
            tabs[0].classList.add('active');
            regSection.style.display = 'block';
            checkSection.style.display = 'none';
        } else {
            tabs[1].classList.add('active');
            regSection.style.display = 'none';
            checkSection.style.display = 'block';
        }
    }

    // Function to format date from YYYY-MM-DD to DD/MM/YYYY
    function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    // --- CHECK MEMBERSHIP LOGIC ---
    window.checkMembership = async function() {
        const checkIC = document.getElementById('check_ic').value.replace(/[^0-9]/g, '');
        const loader = document.getElementById('checkLoader');
        if (checkIC.length < 12) { alert("Sila masukkan No. Kad Pengenalan yang lengkap."); return; }
        loader.style.display = 'block';
        if (!db) { alert("Sistem Pangkalan Data tidak dapat dihubungi."); loader.style.display = 'none'; return; }
        
        try {
            const querySnapshot = await getDocs(collection(db, 'ppd_registrations'));
            let foundData = null;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.ic === checkIC) foundData = data;
            });
            loader.style.display = 'none';
            
            if (foundData) {
                // Populate Card
                document.getElementById('cardName').innerText = foundData.nama;
                document.getElementById('cardIC').innerText = foundData.ic;
                document.getElementById('cardJawatan').innerText = foundData.jawatan;
                document.getElementById('cardDuration').innerText = foundData.tempoh_keahlian_club || "1 TAHUN";
                document.getElementById('cardBarcode').innerText = "*" + foundData.ic + "*";
                document.getElementById('cardMemberID').innerText = foundData.no_keahlian || "BELUM DITETAPKAN"; 
                document.getElementById('cardJoinDate').innerText = formatDate(foundData.tarikh_mula); // Show Join Date

                // Handle Photo in Card
                const cardPhoto = document.getElementById('cardUserPhoto');
                if (foundData.foto_url) {
                    cardPhoto.src = foundData.foto_url;
                } else {
                    cardPhoto.src = "https://via.placeholder.com/150?text=TIADA"; // Fallback
                }

                const overlay = document.getElementById('cardOverlay');
                const printBtn = document.getElementById('btnPrintCard');
                const modalTitle = document.getElementById('modalTitle');
                const modalSubtitle = document.getElementById('modalSubtitle');

                if (foundData.status === 'DISAHKAN') {
                    modalTitle.innerText = "STATUS: AKTIF";
                    modalTitle.style.color = "var(--success-color)";
                    modalSubtitle.innerText = "Keahlian anda adalah SAH.";
                    overlay.style.display = 'none';
                    printBtn.style.display = 'inline-block';
                } else {
                    modalTitle.innerText = "MENUNGGU PENGESAHAN";
                    modalTitle.style.color = "var(--warning-color)";
                    modalSubtitle.innerText = "Permohonan anda sedang disemak oleh Admin.";
                    overlay.style.display = 'flex';
                    printBtn.style.display = 'none';
                }

                document.getElementById('registerFooter').style.display = 'none';
                document.getElementById('checkFooter').style.display = 'block';
                document.getElementById('confirmModal').style.display = 'flex';
            } else {
                if (confirm("Tiada rekod ditemui untuk No. IC: " + checkIC + ".\n\nAdakah anda berminat untuk mendaftar keahlian sekarang?")) {
                    switchTab('daftar');
                    const regIC = document.getElementById('ic_number');
                    regIC.value = checkIC;
                    regIC.dispatchEvent(new Event('input'));
                }
            }
        } catch (error) {
            console.error(error);
            alert("Ralat sistem.");
            loader.style.display = 'none';
        }
    }

    // --- REGISTRATION PREVIEW LOGIC ---
    window.validateAndPreview = function() {
        const fullname = document.getElementById('fullname').value;
        const sector = document.getElementById('sector').value;
        const status = document.getElementById('status_kahwin').value;
        const startDate = document.getElementById('start_date').value;
        const phone = document.getElementById('phone').value;
        const agreement = document.getElementById('agreement_check');
        const ic = document.getElementById('ic_number').value;
        const clubDuration = document.getElementById('hidden_club_duration').value;
        const fotoUrl = document.getElementById('foto_url').value;
        
        // Ambil status checkbox kad fizikal
        const wantPhysicalCard = document.getElementById('physical_card_opt').checked;

        let jawatan = document.getElementById('jawatan_select').value;
        if (jawatan === 'LAIN-LAIN') jawatan = document.getElementById('jawatan_custom').value;

        if(!fullname || !sector || !status || !startDate || !phone || !jawatan) { alert("SILA LENGKAPKAN SEMUA MAKLUMAT BERTANDA."); return; }
        if (!agreement.checked) { alert("SILA TANDAKAN KOTAK PERSETUJUAN."); return; }

        // Papar Maklumat dalam Modal
        document.getElementById('modalTitle').innerText = "SAHKAN MAKLUMAT";
        document.getElementById('modalTitle').style.color = "var(--primary-color)";
        document.getElementById('modalSubtitle').innerText = "Sila semak paparan sebelum menghantar:";
        
        document.getElementById('cardName').innerText = fullname;
        document.getElementById('cardIC').innerText = ic;
        document.getElementById('cardJawatan').innerText = jawatan;
        document.getElementById('cardDuration').innerText = clubDuration || "BARU MENDAFTAR";
        document.getElementById('cardBarcode').innerText = "*" + ic + "*";
        document.getElementById('cardMemberID').innerText = "BARU / PENDING";
        document.getElementById('cardJoinDate').innerText = formatDate(startDate);
        
        // Handle Photo
        const cardPhoto = document.getElementById('cardUserPhoto');
        if (fotoUrl) { cardPhoto.src = fotoUrl; } 
        else { cardPhoto.src = "https://via.placeholder.com/150?text=FOTO"; }
        
        document.getElementById('cardOverlay').style.display = 'none'; 

        // --- LOGIK KIRAAN BAYARAN ---
        let baseFee = 60;
        let cardFee = 13;
        let totalFee = wantPhysicalCard ? (baseFee + cardFee) : baseFee;
        let feeHtml = `YURAN KEAHLIAN: <strong>RM${baseFee.toFixed(2)}</strong>`;
        
        if (wantPhysicalCard) {
            feeHtml += `<br>+ KAD FIZIKAL (PVC): <strong>RM${cardFee.toFixed(2)}</strong>`;
            feeHtml += `<hr style="margin:5px 0; border-top:1px dashed #ccc;">`;
            feeHtml += `JUMLAH PERLU DIBAYAR: <span style="color:red; font-weight:900; font-size:1.2em;">RM${totalFee.toFixed(2)}</span>`;
        } else {
            feeHtml += `<br><span style="color:var(--accent-color); font-weight:900; font-size:1.2em;">TOTAL: RM${totalFee.toFixed(2)}</span>`;
        }
        
        document.getElementById('feeDisplay').innerHTML = feeHtml;
        // ---------------------------

        document.getElementById('registerFooter').style.display = 'block';
        document.getElementById('checkFooter').style.display = 'none';
        
        const btnFinal = document.getElementById('btnFinalSubmit');
        btnFinal.innerText = editingDocId ? "SAHKAN & KEMASKINI" : "SAHKAN & HANTAR";

        document.getElementById('confirmModal').style.display = 'flex';
    }

    window.closeModal = function() { document.getElementById('confirmModal').style.display = 'none'; }

    // --- FINAL SUBMIT LOGIC ---
    window.finalSubmit = async function() {
        if (!db) { alert("Sistem Pangkalan Data tidak dapat dihubungi."); return; }
        if (!currentUser) { alert("Sistem sedang bersambung... Sila tunggu."); return; }
        const modalBtns = document.getElementById('modalBtns');
        const loading = document.getElementById('loading');
        modalBtns.style.display = 'none';
        loading.style.display = 'block';

        let jawatanAkhir = document.getElementById('jawatan_select').value;
        if (jawatanAkhir === 'LAIN-LAIN') jawatanAkhir = document.getElementById('jawatan_custom').value;

        // Ambil nilai checkbox kad fizikal
        const wantPhysicalCard = document.getElementById('physical_card_opt').checked;

        const registrationData = {
            ic: document.getElementById('ic_number').value,
            nama: document.getElementById('fullname').value,
            jantina: document.getElementById('gender').value,
            dob: document.getElementById('dob').value,
            status_kahwin: document.getElementById('status_kahwin').value,
            sektor: document.getElementById('sector').value,
            unit: document.getElementById('unit').value,
            jawatan: jawatanAkhir,
            tarikh_mula: document.getElementById('start_date').value,
            tempoh_khidmat: document.getElementById('hidden_duration').value,
            tempoh_keahlian_club: document.getElementById('hidden_club_duration').value,
            foto_url: document.getElementById('foto_url').value, 
            phone: document.getElementById('phone').value,
            // Simpan status tempahan kad
            tempahan_kad_fizikal: wantPhysicalCard ? "YA" : "TIDAK",
            status: "PENDING", 
            timestamp: new Date().toISOString()
        };

        try {
            if (editingDocId) {
                await updateDoc(doc(db, 'ppd_registrations', editingDocId), registrationData);
                document.getElementById('statusMessage').innerText = "KEMASKINI BERJAYA!";
                setTimeout(() => {
                    alert("MAKLUMAT DIKEMASKINI!\nStatus kini kembali kepada: MENUNGGU PENGESAHAN.");
                    window.closeModal();
                    document.getElementById('registrationForm').reset();
                    detailsDiv.style.display = 'none';
                    editingDocId = null;
                    document.getElementById('mainSubmitBtn').innerText = "DAFTAR KEAHLIAN SEKARANG";
                    document.getElementById('photoPreviewBox').style.display = 'none';
                    document.getElementById('foto_url').value = '';
                    modalBtns.style.display = 'flex';
                    document.getElementById('statusMessage').innerText = "";
                }, 500);
            } else {
                await addDoc(collection(db, 'ppd_registrations'), registrationData);
                document.getElementById('statusMessage').innerText = "PENDAFTARAN BERJAYA!";
                setTimeout(() => {
                    // Papar mesej bayaran dalam alert
                    let msg = "PENDAFTARAN DITERIMA!\nStatus kini: MENUNGGU PENGESAHAN.";
                    if(wantPhysicalCard) {
                        msg += "\n\nSila buat bayaran RM73.00 (Yuran + Kad) kepada Bendahari.";
                    } else {
                        msg += "\n\nSila buat bayaran RM60.00 kepada Bendahari.";
                    }
                    
                    alert(msg);
                    window.closeModal();
                    document.getElementById('registrationForm').reset();
                    detailsDiv.style.display = 'none';
                    document.getElementById('photoPreviewBox').style.display = 'none';
                    document.getElementById('foto_url').value = '';
                    modalBtns.style.display = 'flex';
                    document.getElementById('statusMessage').innerText = "";
                }, 500);
            }
        } catch (error) {
            console.error('Error:', error);
            alert("Ralat sistem!");
            loading.style.display = 'none';
            modalBtns.style.display = 'flex';
        }
    }
    
    window.onclick = function(event) {
        const modal = document.getElementById('confirmModal');
        if (event.target == modal) modal.style.display = "none";
    }
</script>

</body>
</html>
